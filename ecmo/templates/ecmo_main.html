{% extends "ecmo_base.html" %}
{% block title %}ECMO main{% endblock %}
{% block extrascript %}
{% endblock %}
{% block extrastyle %}
{% endblock %}
{% block extrahead %}
   	<script type="text/javascript" src="/static/js/render/render_widget_label.js"></script>
   	<script type="text/javascript" src="/static/js/render/render_widget_graph.js"></script>
   	<script type="text/javascript" src="/static/js/render/render_widget_trend.js"></script>
{% endblock %}
{% block content %}
<script type="text/javascript">

// stuff from titan pad

// $(document).ready(function(){
    // $.get('/page/pumpside', function(conf){
        // $.each(conf, function(idx, wc){
            // var container = $('#'+wc.container),
                // widget = $('<div/>',{
                    // id: wc.div_id,
                    // 'class': 'widget'
                // })
                // // loop over (title, trend, main)
                // $.each(['title', 'trend', 'main'], function(idx, div_type){
                    // $(widget).append($('<div/>',{
                        // id: wc.div_id + '_' + div_type,
                        // 'class': div_type
                    // })
                    // // generate the protovis pieces for (title, trend, main)
                    // $.data(widget, 'pvs')[div] = widget_thing(div_type, wc.div_id + '_' + div_type)
                // })
//                 
            // $.data(widget, 'series', [])
//             
            // var socket = $.websocket("ws://127.0.0.1:8080/", {
                // events: {
                    // message: function(e) {
                        // $.each(wc.series, function(idx, series){
                            // for(b=0;b<series.length;b++){
                                // $.data(widget, 'series')[idx].push(series[b])
                            // }
                        // })
                        // //redraw
//                         
                    // }
                // }
            // });
        // })
//         
    // })
// })

// JSON format for configurations (list of widget conf's):
// [{
//	 container: '', // one of T,L,R,B (top, left, right, bottom)
//   pos: '',       // numerical index of the widget in the container
//   series: []     // list of series names this widget displays such as 'set_low_slow' or 'orders'
//   div_id: '',    // id of the div containing the widget
//	 label: '',        // label for the series e.g. "Post-Membrane Pressure"
//   unit: '',         // the unit of the masurand (e.g. mmHG, %, etc)
//   symbol: '',       // Single letter symbol for the type of measurand (e.g. P for pressure)
// },]

// only for testing. remove after all working
var test_configs = [
	{
		"container": "T",
		"pos": "1",
		"series": ["measurement"],
		"div_id": "premem_pressure",
		"label":"Pre-Membrane Pressure",
		"unit":"mmHG",
		"symbol":"P",
		
	},
	{
		"container": "T",
		"pos": "2",
		"series": ["orders", "measurement"],
		"div_id": "postmem_pressure",
		"label":"Post-Membrane Pressure",
		"unit":"mmHG",
		"symbol":"P",
	},
	{
		"container": "B",
		"pos": "1",
		"series": ["set_low_slow", "set_high_slow","set_low_stop", "set_high_stop","measurement"],
		"div_id": "water_temp",
		"label":"Water Temperature",
		"unit":"Â°C",
		"symbol":"T",
	},
	{
		"container": "L",
		"pos": "1",
		"series": ["orders","measurement"],
		"div_id": "svo2",
		"label":"SVO2",
		"unit":"%",
		"symbol":"S",
	},
	{
		"container": "R",
		"pos": "1",
		"series": ["orders","measurement"],
		"div_id": "sao2",
		"label":"SAO2",
		"unit":"%",
		"symbol":"S",
	},
]

// JSON format for series (list of series...must be in the right order):
// [
// 	// EACH ARRAY SHOULD BE THE SAME SIZE OR EMPTY. EACH ELEMENT CONTAINS A 2 
//  // VALUE LIST. THE FIRST VALUE IS THE TIME (REPRESENTING SECONDS) AND THE 
//  // SECOND ELEMENT IS THE VALUE OF THE ARRAY AT THAT TIME
//   [/*list of high setpoints for slowing*/], 
//   [/*list of low setpoints for slowing*/],
//   [/*list of high setpoints for stopping*/],
//   [/*list of low setpoints for stopping*/],
//   [/*list of measurements of the measurand*/],
//   [/*list of dr's orders for the measurand*/],
// ]

// consts for the indexes of individual series arrays in the uber series array
const SP_SLOW_HIGH_IDX = 0;
const SP_SLOW_LOW_IDX  = 1;
const SP_STOP_HIGH_IDX = 2;
const SP_STOP_LOW_IDX  = 3;
const SERIES_IDX = 4;
const ORDER_IDX = 5;

// consts for the contents of series arrays
const TIME_IDX = 0;
const VAL_IDX = 1;

var test_series = {
	"premem_pressure": [
		_.map(_.range(3600), function(i){return [i, 220]}),
		_.map(_.range(3600), function(i){return [i, 170]}),
		_.map(_.range(3600), function(i){return [i, 230]}),
		_.map(_.range(3600), function(i){return [i, 160]}),
		_.map(_.range(3600), function(i){return [i, get_random(160, 230)]}),
		_.map(_.range(3600), function(i){return [i, 200]}),
	],
	"postmem_pressure": [
		_.map(_.range(3600), function(i){return [i, 220]}),
		_.map(_.range(3600), function(i){return [i, 170]}),
		_.map(_.range(3600), function(i){return [i, 230]}),
		_.map(_.range(3600), function(i){return [i, 160]}),
		_.map(_.range(3600), function(i){return [i, get_random(160, 230)]}),
		_.map(_.range(3600), function(i){return [i, 200]}),
	],
	"water_temp": [
		_.map(_.range(3600), function(i){return [i, 38]}),
		_.map(_.range(3600), function(i){return [i, 35]}),
		_.map(_.range(3600), function(i){return [i, 39]}),
		_.map(_.range(3600), function(i){return [i, 34]}),
		_.map(_.range(3600), function(i){return [i, get_random(34, 39)]}),
		_.map(_.range(3600), function(i){return [i, 37]}),
	],
	"svo2": [
		[[0, 220], [1, 220], [2, 220], [3, 220], [4, 220], [5, 220], [6, 220], [7, 220], [8, 220], [9, 220], [10, 220]],
		[[0, 170], [1, 170], [2, 170], [3, 170], [4, 170], [5, 170], [6, 170], [7, 170], [8, 170], [9, 170], [10, 170]],
		[[0, 230], [1, 230], [2, 230], [3, 230], [4, 230], [5, 230], [6, 230], [7, 230], [8, 230], [9, 230], [10, 230]],
		[[0, 160], [1, 160], [2, 160], [3, 160], [4, 160], [5, 160], [6, 160], [7, 160], [8, 160], [9, 160], [10, 160]],
		[[0, get_random(160, 230)], [1, get_random(160, 230)], [2, get_random(160, 230)], [3, get_random(160, 230)], 
				[4, get_random(160, 230)], [5, get_random(160, 230)], [6, get_random(160, 230)], [7, get_random(160, 230)], 
				[8, get_random(160, 230)], [9, get_random(160, 230)], [10, get_random(160, 230)]],
		[[0, 200], [1, 200], [2, 200], [3, 200], [4, 200], [5, 200], [6, 200], [7, 200], [8, 200], [9, 200], [10, 200]],
	],
	"sao2": [
		[[0, 220], [1, 220], [2, 220], [3, 220], [4, 220], [5, 220], [6, 220], [7, 220], [8, 220], [9, 220], [10, 220]],
		[[0, 170], [1, 170], [2, 170], [3, 170], [4, 170], [5, 170], [6, 170], [7, 170], [8, 170], [9, 170], [10, 170]],
		[[0, 230], [1, 230], [2, 230], [3, 230], [4, 230], [5, 230], [6, 230], [7, 230], [8, 230], [9, 230], [10, 230]],
		[[0, 160], [1, 160], [2, 160], [3, 160], [4, 160], [5, 160], [6, 160], [7, 160], [8, 160], [9, 160], [10, 160]],
		[[0, get_random(160, 230)], [1, get_random(160, 230)], [2, get_random(160, 230)], [3, get_random(160, 230)], 
				[4, get_random(160, 230)], [5, get_random(160, 230)], [6, get_random(160, 230)], [7, get_random(160, 230)], 
				[8, get_random(160, 230)], [9, get_random(160, 230)], [10, get_random(160, 230)]],
		[[0, 200], [1, 200], [2, 200], [3, 200], [4, 200], [5, 200], [6, 200], [7, 200], [8, 200], [9, 200], [10, 200]],
	],
}

	
var data_url = "/ecmo/widget_confs/json";
var configs = null;

function create_widget_div(conf){
	var widget = $('<div/>',{
        id: conf.div_id + "-" + conf.container + "-" + conf.pos,
        'class': 'widget'
    })
    
    // loop over (title, trend, main)
    $.each(['label', 'trend', 'graph'], function(idx, div_type){
        $(widget).append($('<div/>',{
        	// be sure to get the id of the widget as the base for this div's id
            id: $(widget).attr('id') + '-' + div_type,
            'class': div_type
        }))
        // generate the protovis pieces for (title, trend, main)
//        $.data(widget, 'pvs')[div] = widget_thing(div_type, wc.div_id + '_' + div_type)
    })	
    
    var container = $('#'+conf.container)
    container.append(widget)
    
     $.data(widget, 'conf', conf)
     $.data(widget, 'series', test_series[conf.div_id])
}

function render_widget(widget_conf, widget_data){
	var widget_div_id = widget_conf.div_id + "-" + widget_conf.container + "-" + widget_conf.pos
	render_widget_graph(widget_div_id+"-graph", widget_conf, widget_data);
	render_widget_trend(widget_div_id+"-trend", widget_conf, widget_data);
	render_widget_label(widget_div_id+"-label", widget_conf, widget_data)
}
     		
$(document).ready(function() {
	$.get(data_url, function(fetched_configs){
        configs = fetched_configs
        $.each(configs, function(idx, conf){
        	create_widget_div(conf)
			render_widget(conf, test_series[conf.div_id])
		})
    })
    
	
});

</script>
<!-- 
	These are the screen regin divs for the dashboard view (hence db_ prefix). 
	We have a (T)op, (B)ottom, (L)eft, (R)ight and (C)enter region.
-->
<div class="outer">
<div id="db_T" class="widget_row"></div>
<div id="db_L" class="widget_col_left"></div>
<div id="db_C" class="viz_center"></div>
<div id="db_R" class="widget_col_right"></div>
<div id="db_B" class="widget_row"></div>
</div>
{% endblock %}
